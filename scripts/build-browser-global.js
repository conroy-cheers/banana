#!/usr/bin/env node
"use strict";

const fs = require("node:fs");
const path = require("node:path");

const root = process.cwd();
const configPath = path.join(root, "src/sim/config.mjs");
const enginePath = path.join(root, "src/sim/engine.mjs");
const metricsPath = path.join(root, "src/sim/metrics.mjs");
const outPath = path.join(root, "src/sim/browser-global.js");

function stripExports(src) {
  return src.replace(/^export\s+/gm, "");
}

function stripEngineImports(src) {
  return src
    .replace(/^import\s+\{[^\n]+\}\s+from\s+"\.\/config\.mjs";\n?/m, "")
    .replace(/^export\s+class\s+BananaPileEngine/m, "class BananaPileEngine");
}

const config = stripExports(fs.readFileSync(configPath, "utf8"));
const engine = stripEngineImports(fs.readFileSync(enginePath, "utf8"));
const metrics = stripExports(fs.readFileSync(metricsPath, "utf8"));

const output = `/* auto-generated by scripts/build-browser-global.js */\n(function () {\n${config}\n\n${engine}\n\n${metrics}\n\nwindow.BananaSim = {\n  BananaPileEngine,\n  computeJostlingMetrics,\n  computeCompressionMetrics,\n  summarizePileMetrics,\n};\n})();\n`;

fs.writeFileSync(outPath, output, "utf8");
console.log(`wrote ${path.relative(root, outPath)}`);
